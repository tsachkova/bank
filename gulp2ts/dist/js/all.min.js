var __awaiter=this&&this.__awaiter||function(t,i,o,l){return new(o=o||Promise)(function(n,e){function a(t){try{c(l.next(t))}catch(t){e(t)}}function r(t){try{c(l.throw(t))}catch(t){e(t)}}function c(t){var e;t.done?n(t.value):((e=t.value)instanceof o?e:new o(function(t){t(e)})).then(a,r)}c((l=l.apply(t,i||[])).next())})},__generator=this&&this.__generator||function(a,r){var c,i,o,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(n){return function(t){var e=[n,t];if(c)throw new TypeError("Generator is already executing.");for(;l;)try{if(c=1,i&&(o=2&e[0]?i.return:e[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,e[1])).done)return o;switch(i=0,(e=o?[2&e[0],o.value]:e)[0]){case 0:case 1:o=e;break;case 4:return l.label++,{value:e[1],done:!1};case 5:l.label++,i=e[1],e=[0];continue;case 7:e=l.ops.pop(),l.trys.pop();continue;default:if(!(o=0<(o=l.trys).length&&o[o.length-1])&&(6===e[0]||2===e[0])){l=0;continue}if(3===e[0]&&(!o||e[1]>o[0]&&e[1]<o[3]))l.label=e[1];else if(6===e[0]&&l.label<o[1])l.label=o[1],o=e;else{if(!(o&&l.label<o[2])){o[2]&&l.ops.pop(),l.trys.pop();continue}l.label=o[2],l.ops.push(e)}}e=r.call(a,l)}catch(t){e=[6,t],i=0}finally{c=o=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},calculateBankData={};function convertMoney(n,t,e,a){if(3!==t.length&&"string"!=typeof t)throw new Error("invalid currency type format");var r,c;return 0<=e&&a===t?e:("UAH"!==t&&(c=i(t)),0<=e&&"UAH"!==a?(a=i(a),a=e*Number(a.sale),"UAH"===t?a:a/Number(c.sale)):0<=e?e/Number(c.sale):void 0);function i(t){for(var e=0;e<n.length;e++)t===n[e].ccy&&(r=n[e]);if(void 0===n)throw alert("this type of currency is not found"),document.querySelector("body").innerHTML="",returnStartForm(),new Error("this type of currency is not found");return r}}function calculatSumBank(t,e,n){for(var a=0,r=n.bind({},t,e),c=0;c<bank.length;c++){for(var i=bank[c],o=i.credit,l=i.debet,u=0;u<o.length;u++)0<o[u].ownMoney&&(a+=r(o[u].ownMoney,o[u].currency)),a+=r(o[u].creditMoney,o[u].currency);for(u=0;u<bank[c].debet.length;u++)a+=r(l[u].ownMoney,l[u].currency)}calculateBankData.allBankSum=a}function calculatDebt(t,e,n,a,r,c){for(var i=0,o=0,l=0;l<bank.length;l++){var u=0;if(!c||c(bank[l])){for(var m=0;m<bank[l].credit.length;m++)bank[l].credit[m].ownMoney<0&&(i+=n(t,e,Math.abs(bank[l].credit[m].ownMoney),bank[l].credit[m].currency),u=u||1);o+=u}}calculateBankData[a]=i,r&&(calculateBankData[r]=o)}function debtActive(t){if(t.isActive)return!0}function debtNotActive(t){if(!t.isActive)return!0}function toCalculateBankMoney(n,a){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,fetch("https://api.privatbank.ua/p24api/pubinfo?json&exchange&coursid=5")];case 1:return(e=t.sent().json()).then(function(t){return calculatSumBank(t,n,a)}),e.then(function(t){return calculatDebt(t,n,a,"sumDebtActive","countDebtActiveUser",debtActive)}),e.then(function(t){return calculatDebt(t,n,a,"sumDebtNotActive","countNotActiveDebtor",debtNotActive)}),e.then(function(t){return calculatDebt(t,n,a,"allDebtSum")}),e.then(function(){return putCalculateData(calculateBankData,n)}),[2]}})})}var createFormCallback=function(t){mainForm.innerHTML="";var e=document.createElement("legend");e.textContent="Кредит";t.querySelector("#credit").append(e);e=document.createElement("legend");e.textContent="Дебит",t.querySelector("#debet").append(e)},creditAccountFormCallback=function(t){t.insertAdjacentHTML("afterbegin",'<p><label for="limit">кредитный лимит</label><input type="text" class="limit" placeholder="0" autocomplete= "off"></p>')},editFormCallback=function(t){var e=document.createElement("legend");e.textContent="Редактирование данных",t.prepend(e),createFormCallback(t)},deleteUserFormCallback=function(t){var e=document.querySelector("#search");e.value="Удалить",e.id="deleteUserButton"},addHtmlForm=function(){function t(t,e,n){this.container=document.createElement("fieldset"),this.dataHtml=e,this.parent=t,this.callback=n}return t.prototype.createNewElement=function(t,e){n=t.element,n=document.createElement(n),a&&Object.assign(n,a);var n,a=n;return"string"==typeof t.element&&(a=document.createElement(t.element),t.name&&a.setAttribute("name","".concat(t.name)),t.id&&(a.id=t.id),t.className&&a.setAttribute("class","".concat(t.className)),t.type&&a.setAttribute("type","".concat(t.type)),t.value&&a.setAttribute("value","".concat(t.value)),t.for&&a.setAttribute("for","".concat(t.for)),t.size&&a.setAttribute("size","".concat(t.size)),t.textContent&&(a.textContent="".concat(t.textContent)),t.placeholder&&a.setAttribute("placeholder","".concat(t.placeholder))),e.append(a),this},t.prototype.createFragment=function(){for(var t=0;t<this.dataHtml.length;t++){var e=void 0,n=void 0;(e=this.dataHtml[t]).p?(n=document.createElement("p"),this.createNewElement(e,n),e.nextElement&&(e=e.nextElement,this.createNewElement(e,n)),this.container.append(n)):(n=this.container,this.createNewElement(e,n),e.nextElement&&(e=e.nextElement,this.createNewElement(e,n)))}return this},t.prototype.addFragment=function(){this.callback&&this.callback(this.container),this.parent.append(this.container)},t.prototype.addSelectOption=function(){for(var t=this.container.querySelector("select"),e=["UAH","EUR","USD"],n=0;n<e.length;n++){var a=document.createElement("option");a.value=e[n],a.innerHTML=e[n],t.append(a)}return this},t}();function clearParents(t){t.innerHTML=""}function returnStartForm(){editedClientGetPut=editedClientGetPut&&null,clearParents(document.querySelector("#mainForm")),new addHtmlForm(startParents,startHtmlData).createFragment().addSelectOption().addFragment()}var editedClientGetPut,bank=[],Account=function(t,e,n,a,r,c){this.currency=e,this.ownMoney=t,this.isActive=n,this.dateActive=a,this.creditMoney=r,this.limit=c},Client=function(){function t(t,e,n,a,r){this.debet=[],this.credit=[],this.id=a,this.firstName=t,this.lastName=e,this.isActive=n,this.date=r}return t.prototype.addAccount=function(t){for(var e=0;e<t.length;e++)if(t[e].hasOwnProperty("limit")){if(t[e].ownMoney<0)throw new Error("exceeded credit limit");var n=0<t[e].ownMoney-t[e].limit&&t[e].limit||t[e].ownMoney,a=t[e].ownMoney-t[e].limit;this.credit.push(new Account(a,t[e].currency,t[e].isActive,t[e].dateActive,n,t[e].limit))}else{if(t[e].ownMoney<0)throw new Error("debet account must be greater than zero");this.debet.push(new Account(t[e].ownMoney,t[e].currency,t[e].isActive,t[e].dateActive))}return this},t}();function getSearchUserData(t){for(var e=0;e<bank.length;e++)if(bank[e].id===Number(t))return bank[e]}function deleteUser(t){for(var e=0;e<bank.length;e++)if(bank[e].id===Number(t))return void bank.splice(e,1);alert("Нет клиента с таким ID")}var GetPutClientData=function(){function t(t){this.clientData=t}return t.prototype.putEditedClientData=function(){if(this.clientData){this.idEditClient=this.clientData.id,this.dateEditClient=this.clientData.date,document.getElementById("firstName").value=this.clientData.firstName,document.getElementById("lastName").value=this.clientData.lastName,this.clientData.isActive&&document.getElementById("isActive").setAttribute("checked","checked"),document.getElementById("idEditClient").textContent+="".concat(this.clientData.id),document.getElementById("dateEditClient").textContent+="".concat(this.clientData.date);for(var t=document.getElementById("debet"),e=0;e<this.clientData.debet.length;e++)new Accounts({bankAcountsData:this.clientData.debet[e]},t).generateAccountsForm().putAccountsData();for(var n=document.getElementById("credit"),e=0;e<this.clientData.credit.length;e++)new Accounts({bankAcountsData:this.clientData.credit[e]},n).generateAccountsForm().putAccountsData()}else alert("в базе нет клиента c таким id"),returnStartForm()},t.prototype.getClientData=function(){var t=document.getElementById("firstName").value,e=document.getElementById("lastName").value;if(t&&e){var n,a=document.getElementById("isActive").checked,r="",c=(this.dateEditClient?r=this.dateEditClient:null!==(n=(new Date).toString().match(/[A-Za-z]{3}\s\d\d\s\d{4}/))&&(r=n[0]),1);if(this.idEditClient)c=Number(this.idEditClient);else for(var i=0;i<bank.length;i++)c<=bank[i].id&&(c=bank[i].id+1);for(var o=document.getElementById("debet").getElementsByTagName("fieldset"),l=document.getElementById("credit").getElementsByTagName("fieldset"),u=[],i=0;i<o.length;i++)(m=new Accounts({accountsForm:o[i]}).getAccountsData())&&u.push(m);for(var m,i=0;i<l.length;i++)(m=new Accounts({accountsForm:l[i]}).getAccountsData())&&u.push(m);return{firstName:t,lastName:e,isActive:a,date:r,id:c,accounts:u}}alert("введите имя и фамилию"),document.getElementById("firstName").value="",document.getElementById("lastName").value=""},t.prototype.deleteOldUserData=function(){return deleteUser(Number(this.idEditClient)),this},t}(),Accounts=function(){function t(t,e){this.accountForm=t.accountsForm,this.accountsContainer=e,this.bankAcountsData=t.bankAcountsData}return t.prototype.generateAccountsForm=function(){return this.accountsContainer&&(this.bankAcountsData&&(this.bankAcountsData.limit||0===this.bankAcountsData.limit)?new addHtmlForm(this.accountsContainer,debitDataHtml,creditAccountFormCallback):new addHtmlForm(this.accountsContainer,debitDataHtml)).createFragment().addFragment(),this},t.prototype.putAccountsData=function(){var t;this.bankAcountsData&&this.accountsContainer&&(t=this.accountsContainer.lastElementChild,this.bankAcountsData.limit||0===this.bankAcountsData.limit?(t.querySelector(".limit").value=this.bankAcountsData.limit.toString(),t.querySelector(".ownSum").value=(this.bankAcountsData.limit+this.bankAcountsData.ownMoney).toString()):t.querySelector(".ownSum").value=this.bankAcountsData.ownMoney.toString(),this.bankAcountsData.isActive&&t.querySelector(".isActive").setAttribute("checked","checked"),t.querySelector(".currency").closest("p").innerHTML='\n            <p><label for="currency" >валюта счета</label>\n            <select class = "currency" size="1">\n                <option selected  value= '.concat(this.bankAcountsData.currency,">").concat(this.bankAcountsData.currency,"</option>\n            </select></p>"))},t.prototype.getAccountsData=function(){var t;if(this.accountForm)return t=Number(this.accountForm.querySelector(".ownSum").value)||0,t={currency:this.accountForm.querySelector(".currency").value,ownMoney:t,isActive:this.accountForm.querySelector(".isActive").checked,dateActive:(new Date).toString()},this.accountForm.querySelector(".limit")&&(t.limit=+this.accountForm.querySelector(".limit").value||0),t},t}();function putCalculateData(t,e){for(var n=document.querySelector("fieldset").querySelectorAll("input"),a=0;a<n.length;a++)"text"===n[a].type&&(n[a].previousSibling.textContent+=e,n[a].value=t[n[a].id])}var startHtmlData=[{element:"input",type:"button",value:"создать нового пользователя",id:"createUser",p:!0},{element:"input",type:"button",value:"изменить данные пользователя",id:"editUser",p:!0},{element:"input",type:"button",value:"удалить пользователя",id:"deleteUser",p:!0},{element:"input",type:"button",value:"Рассчитать суммарные показатели по банку",id:"calculateBank",p:!0},{element:"label",for:"calculateCurrency",textContent:"рассчетная валюта  ",nextElement:{element:"select",id:"calculateCurrency",size:"1"}}],createUserData=[{p:!0,element:"label",for:"firstName",textContent:"Имя ",nextElement:{element:"input",type:"text",id:"firstName",name:"firstName"}},{p:!0,element:"label",for:"lastName",textContent:"Фамилия ",nextElement:{element:"input",type:"text",id:"lastName",name:"lastName"}},{p:!0,element:"label",for:"isActive",textContent:"Активность аккаунта",nextElement:{element:"input",type:"checkbox",id:"isActive"}},{element:"fieldset",id:"debet"},{element:"fieldset",id:"credit"},{element:"input",type:"button",value:"добавить дебитовый счет",id:"debitAccount"},{element:"input",type:"button",value:"добавить кредитовый счет",id:"creditAccount"},{p:!0,element:"input",type:"button",id:"submit",value:"Применить"},{p:!0,element:"input",type:"button",id:"back",value:"  Отмена  "}],debitDataHtml=[{p:!0,element:"label",for:"ownSum",textContent:"сумма на счету",nextElement:{element:"input",type:"text",className:"ownSum",placeholder:"0"}},{p:!0,element:"label",for:"isActive",textContent:"счет активен",nextElement:{element:"input",type:"checkbox",className:"isActive"}},{p:!0,element:"label",for:"currency",textContent:"валюта счета",nextElement:{element:"select",className:"currency",size:"1"}},{p:!0,element:"input",type:"button",className:"deleteAccount",value:"удалить"}],searchDataHtml=[{element:"legend",textContent:"Изменение данных"},{p:!0,element:"label",for:"id",textContent:"id",nextElement:{element:"input",type:"text",id:"id"}},{p:!0,element:"input",type:"button",id:"search",value:"Искать"},{p:!0,element:"input",type:"button",id:"back",value:"Назад"}],editUserData=[{element:"p",textContent:"ID клиента - ",id:"idEditClient"},{element:"p",textContent:"Дата регистрации - ",id:"dateEditClient"}],editUserDataHtml=editUserData.concat(createUserData),calculateFormData=[{p:!0,element:"label",for:"allBankSum",textContent:"сумма средств по банку в ",nextElement:{element:"input",type:"text",id:"allBankSum",name:"allBankSum"}},{p:!0,element:"label",for:"sumDebtActive",textContent:"сумма задолженности активных клиентов по банку в ",nextElement:{element:"input",type:"text",id:"sumDebtActive",name:"sumDebtActive"}},{p:!0,element:"label",for:"countDebtActiveUser",textContent:"количество активных клиентов - должников ",nextElement:{element:"input",type:"text",id:"countDebtActiveUser",name:"countDebtActiveUser"}},{p:!0,element:"label",for:"sumDebtNotActive",textContent:"сумма задолженности неактивных клиентов по банку в  ",nextElement:{element:"input",type:"text",id:"sumDebtNotActive",name:"sumDebtNotActive"}},{p:!0,element:"label",for:"countNotActiveDebtor",textContent:"количество неактивных клиентов - должников ",nextElement:{element:"input",type:"text",id:"countNotActiveDebtor",name:"countNotActiveDebtor"}},{p:!0,element:"label",for:"allDebtSum",textContent:"сумма общей задолженности по банку в ",nextElement:{element:"input",type:"text",id:"allDebtSum",name:"allDebtSum"}},{p:!0,element:"input",type:"button",id:"back",value:"Назад"}],mainForm=(console.log(document.body),document.body.append(document.createElement("form")),document.querySelector("form")),startParents=(console.log(mainForm),mainForm.id="mainForm",document.querySelector("form"));function listiners(){document.body.addEventListener("click",function(t){if(t.target){if("createUser"===t.target.id&&(clearParents(document.querySelector("#mainForm")),new addHtmlForm(document.querySelector("#mainForm"),createUserData,createFormCallback).createFragment().addFragment()),"submit"===t.target.id){var e=void 0;if(editedClientGetPut?(e=editedClientGetPut.deleteOldUserData().getClientData(),editedClientGetPut=null):e=(new GetPutClientData).getClientData(),!e)return;bank.push(new Client(e.firstName,e.lastName,e.isActive,e.id,e.date).addAccount(e.accounts)),returnStartForm()}t.target.classList.contains("deleteAccount")&&(t.target.closest("fieldset").outerHTML=""),"debitAccount"===t.target.id&&new addHtmlForm(document.querySelector("#debet"),debitDataHtml).createFragment().addSelectOption().addFragment(),"creditAccount"===t.target.id&&new addHtmlForm(document.querySelector("#credit"),debitDataHtml,creditAccountFormCallback).createFragment().addSelectOption().addFragment(),"editUser"===t.target.id&&(clearParents(document.querySelector("#mainForm")),new addHtmlForm(document.querySelector("#mainForm"),searchDataHtml).createFragment().addFragment()),"search"===t.target.id&&(e=getSearchUserData(document.querySelector("#id").value),clearParents(document.querySelector("#mainForm")),new addHtmlForm(document.querySelector("#mainForm"),editUserDataHtml,editFormCallback).createFragment().addFragment(),(editedClientGetPut=new GetPutClientData(e)).putEditedClientData()),"back"===t.target.id&&returnStartForm(),"deleteUser"===t.target.id&&(clearParents(document.querySelector("#mainForm")),new addHtmlForm(document.querySelector("#mainForm"),searchDataHtml,deleteUserFormCallback).createFragment().addFragment()),"deleteUserButton"===t.target.id&&(deleteUser(document.querySelector("#id").value),returnStartForm()),"calculateBank"===t.target.id&&(toCalculateBankMoney(document.getElementById("calculateCurrency").value,convertMoney),clearParents(document.querySelector("#mainForm")),new addHtmlForm(document.querySelector("#mainForm"),calculateFormData).createFragment().addFragment())}}),document.body.addEventListener("focusout",function(t){t.preventDefault(),!t.target.classList.contains("ownSum")&&!t.target.classList.contains("limit")||/^\d+$/.test(t.target.value)||0===t.target.value.length||(alert("Поля 'сумма на счету' и 'кредитный лимит' должны содержать только цифры"),t.target.value=""),"firstName"!==t.target.id&&"lastName"!==t.target.id||/^[A-Za-z]+$/.test(t.target.value)||""===t.target.value||(alert("Поля 'Имя' и 'Фамилия' должны содержать только буквы"),t.target.value="")})}new addHtmlForm(startParents,startHtmlData).createFragment().addSelectOption().addFragment(),listiners();